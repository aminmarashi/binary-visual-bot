orbs:
  docker: circleci/docker@0.5.13
  gcp-gke: circleci/gcp-gke@0.2.0
version: 2.1
jobs:
  build:
    machine: true
    #docker:
    #  - image: circleci/node:10.16.3
    steps:
      - checkout
      - run:
          name: Install dependency
          command: npm i
      - run:
          name: Perform unit tests
          command: npm test
      - run:
          name: Build code
          command: npm run build-min
          #- run:
          #name: Build image
          # command: docker build -t binary-bot-nginx .  
      - docker/build:
          image: gokulakrishna/binary-bot
      - docker/check
      - docker/push:
          image: gokulakrishna/binary-bot
workflows:
  deploy_kubernetes:
    jobs:
      - build
      - gcp-gke/publish-and-rollout-image:
          requires:
            - build
          cluster: binary-bot
          deployment: binary-bot-node
          container: binary-bot
          registry-url: docker.io
          tag: $CIRCLE_SHA1 
          image: gokulakrishna
